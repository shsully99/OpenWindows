{% extends 'base.html' %}

{% block head %}
<title>Search</title>

<script language="javascript" type="text/javascript">
    
    window.onload = function(){
        //document.getElementById("company_name").value = "value";
        //alert (document.getElementById("elementtype").value)
        // Seyt         
        FilterConfig(document.getElementById("elementtype").value)
    }

    //$(document).ready(
      
    //try{
    //        $('#elementtype').onchange(FilterConfig));
    //    }



    //    catch(err) {
    //        document.getElementById("demo").innerHTML = err.message;
    //    }
        //function FilterConfig(val)
        //Call FilterConfig("Vent");
        //function InitForms(){
         //alert("Loadeds")}

    $(document).ready(
        function(){
            $('[data-bs-toggle="popover"]').popover({ container: 'body' });   
        })
    
    $('.popover-dismiss').popover({
        trigger: 'focus'
    })

</script>

{% endblock %}

{% block body %}

<!-- The dql div is assigned by the script when the type is changed. It gets round the problem of not being able to reference session variables-->
<div id="dql"
    data-def0 = '{{ session["defaultquantitylist"][0] }}'
    data-def1 = '{{ session["defaultquantitylist"][1] }}'
    data-def2 = '{{ session["defaultquantitylist"][2] }}'
    data-def3 = '{{ session["defaultquantitylist"][3] }}'
    data-def4 = '{{ session["defaultquantitylist"][4] }}' ></div>
</div>

<form onload = InitForm() action="/search" method="POST">
<div class="container" >
    <div class="row" >
        <div class = "col-8 measurement_result_block" >
        <!-- <div class = "col-8 measurement_result_block" style = "border:5px solid red; ">
             <div class="measurement_result_block">
                <div class="measure_noise_block_inner"> -->
            <div class = "container measure_noise_block_inner">
                <div class = "row">
                    <div class = "col-3 " >
                        <label class = "TopFormBold">Facade Noise  </label>                    
                    </div>                        
                    <div class = "col-5 " >
                        <label class = "TopFormBold">Level </label>
                        <label class = "TopFormBold">     Spectra dB(A) </label>

                        <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Free-field noise level at the facade.  " data-bs-content="Enter the value of the overall noise level in the left hand box OR spectra for 125-2000 Hz in the right, separated by tabs or slashes."> ? </a> 
                    </div>                        
                  
                    <div class = "col-4 " >
                        {% if session["selectedelements"]|length > 0 %}
                            <label class = "TopFormBold"> Estimated Internal Noise Level dB(A)</label>
                            <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Noise level at the facade.  " data-bs-content=" The values shown below are the internal noise levels for the room estimated taking the facade noise level into account and the elements you have selected for the facade."> ? </a> 
                        {% endif %}
                    </div>                        
                </div>                        
                <div class = "row">
                    {% set facade = facadedetails[0] %}                     
                    <div class = "col-3 " >
                        <label class = "TopForm"> {{ facade.Label|safe }} </label>
                    </div>
                    <div class = "col-5 " >
                        <span>
                            <input type="text" name="Laeq16Level" id="Laeq16Level" class = "TopForm SpectraLeft"
                            onchange="ValLevel(this.value,1)" 
                            value="{{ facade.FacadeLevel }}"
                            {{ session["disabled"] }} >                        
                            <input type="text" name="Laeq16Spectra" id="Laeq16Spectra" class = "TopForm SpectraRight"
                            onchange="ValSpectra(this.value,1)" 
                            value="{{ facade.FacadeSpectra }}"
                            {{ session["disabled"] }} >
                        </span>
                    </div>
                    <div class = "col-4"  >
                        {% if session["selectedelements"]|length > 0 %}
                            <label class = "TopFormBold {{ facade.facadeBackColourClass|safe }}">{{ facade.InternalDisplay }}</label>
                        {% endif %}   
                    </div>
                </div>
                <div class = "row">
                    {% set facade = facadedetails[1] %}                    
                    <div class = "col-3 ">
                        <label class = "TopForm"> {{ facade.Label|safe }} </label>
                    </div>
                    <div class = "col-5"  >
                        <span>
                            <input type="text" name="Laeq8Level" id="Laeq8Level" class = "TopForm SpectraLeft"
                            onchange="ValLevel(this.value,2)" 
                            value="{{ facade.FacadeLevel }}" 
                            {{ session["disabled"] }} >                        
                            <input type="text" name="Laeq8Spectra" id="Laeq8Spectra" class = "TopForm SpectraRight"
                            onchange="ValSpectra(this.value,2)" 
                            value="{{ facade.FacadeSpectra }}"
                            {{ session["disabled"] }} >
                        </span>
                    </div>
                    <div class = "col-4"  >
                        {% if session["selectedelements"]|length > 0 %}
                            <label class = "TopFormBold {{ facade.facadeBackColourClass|safe }}">{{ facade.InternalDisplay }}</label>
                        {% endif %}
                    </div>
                </div>
                <div class = "row">
                    {% set facade = facadedetails[2] %}                    
                    <div class = "col-3 ">
                        <label class = "TopForm">  {{ facade.Label|safe }} </label>
                    </div>
                    <div class = "col-5" >
                        <span>
                            <input type="text" name="LamaxvLevel" id="LamaxvLevel" class = "TopForm SpectraLeft"
                            onchange="ValLevel(this.value,3)" 
                            value="{{ facade.FacadeLevel }}"
                            {{ session["disabled"] }} >                        
                            <input type="text" name="LamaxvSpectra" id="LamaxvSpectra" class = "TopForm SpectraRight"
                            onchange="ValSpectra(this.value,3)" 
                            value="{{ facade.FacadeSpectra }}"
                            {{ session["disabled"] }} >
                        </span>
                    </div>
                    <div class = "col-4"  >
                        {% if session["selectedelements"]|length > 0 %}
                        <label class =  "TopFormBold {{ facade.facadeBackColourClass|safe }} ">{{ facade.InternalDisplay }} </label>
                        {% endif %}
                    </div>
                </div>
                <div class = "row">
                    {% set facade = facadedetails[3] %}                    
                    <div class = "col-3" class = "TopForm"><span></span>
                        <label class = "TopForm"> {{ facade.Label|safe }} </label>
                    </span></div>
                    <div class = "col-5">
                        <span>
                            <input type="text" name="LamaxoLevel" id="LamaxoLevel" class = "TopForm SpectraLeft"
                            onchange="ValLevel(this.value,4)" 
                            value="{{ facade.FacadeLevel }}"
                            {{ session["disabled"] }}>                        
                            <input type="text" name="LamaxoSpectra" id="LamaxoSpectra" class = "TopForm SpectraRight"
                            onchange="ValSpectra(this.value,4)" 
                            value="{{ facade.FacadeSpectra }}"
                            {{ session["disabled"] }}>
                        </span>
                    </div>
                    <div class = "col-4"  >
                        {% if session["selectedelements"]|length > 0 %}
                        <label class =  "TopFormBold {{ facade.facadeBackColourClass|safe }} " >{{ facade.InternalDisplay }} </label>
                        {% endif %}
                    </div>
                </div>
                <!-- <div class = "row ">
                    <div class = "col-8 shortline">
                    </div>
                </div> -->

            </div>
        </div>
            <!-- <div class = "col-8 measurement_result_block" style = "border:5px solid red; ">
                 <div class="measurement_result_block">
                    <div class="measure_noise_block_inner"> -->


        
        <!-- <div class = "col-4" style = "border:5px solid blue;  ">
            <div class = "container"> --> 

        <div class = "col-4 measurement_result_block">
            <div class = "container measure_noise_block_inner"> 
                <div class="row">
                    <div class = "col-5"><span>
                        <label class = "TopForm">Room Size</label>
                        <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Rooms Dimensions" data-bs-content=" Enter room volume (m3) OR floor area (m2) x height(m) OR length(m) x width(m) x height(m). Once entered, the field will redisplay area(m2) and height(m).">?</a>
                    </span>                        
                    </div> 
                    <div class = "col-7">
                        <span>
                            <input name="RoomDimensions" id="RoomDimensions" type="text"
                            placeholder="Enter floor area(m2) x height(m), alternatively length"
                            class = "TopForm RoomDim"
                            onchange="ValRoomDimensions(this.value)"
                            value="{{ session['RoomDimensions']}}  "
                            {{ session["disabled"] }}>

                            <label class = "TopForm" for = "RoomDimensions" name="RoomDimensionsLabel" id="RoomDimensionsLabel">
                            {{ session['gsVolume']|round(1) }}m</label><sup>3</sup>
                        </span> 
                    </div>                                           
                </div>
                <div class="row">
                    <div class = "col-5"><span>
                        <label class = "TopForm">Element Type</label>
                        <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Element Type" data-bs-content="Enter Facade Element Type from the drop down list">?</a>
                    </span>                        
                    </div> 
                    <div class = "col-7">
                        <select name="elementtype" 
                        id = "elementtype"
                        onchange='FilterConfig(this.value)' class = "TopForm">
                        {% for i in range(5) %}
                            <option name="{{ i }}" value="{{ session['elementtypeslist'][i] }}"
                                    {{'selected' if session['elementtypeslist'][i] == session["gstrFilterElementType"]}}>
                                    {{ session['elementtypeslist'][i] }}
                            </option>
                        {% endfor %}
                        </select>                        
                    </div>                                           
                </div>

                <div class="row" id="qRow">
                    <div class = "col-5"><span>
                        <label  class= "TopForm" name="QuantityLabel" id ="QuantityLabel"> Area </label>
                        <a id = "QuantityQuery" tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Area" data-bs-content="For doors, glazing and walls enter the area in m2. For vents enter the maximum equivalent area for ventilation in mm2. ">?</a>
                    </span>
                    </div> 
                    <div class = "col-7">
                        <span>
                            <input type="text" placeholder="Type area"
                                class = "TopForm RoomDim"
                                name="Quantity" id="Quantity"
                                value="{{ session['gsFilterQuantity'] }}">
                                <label name="QuantityMetric" id="QuantityMetric" class = "TopForm">m<sub>2</sub></label>
                        </span>
                    </div>                                           
                </div>

                <div class="row">
                    <div class = "col-5"><span>
                        <label class = "TopForm">Quieter Facade</label>
                        <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Quieter Facade" data-bs-content="If this element is exposed to lower levels than the facade levels you entered on the left select the difference in noise level from the dropdown. ">?</a>
                    </span></div> 
                    <div class = "col-7">
                        <select name="quietfacade" class = "TopForm" >
                            {% for i in range(11) %}
                                <option name="{{ i }}" value="{{ i }}" {{
                                'selected' if
                                i==session['gsFacadeDifference'] }}>
                                    {% if i == 0 %}
                                        Main Facade
                                    {% else %}
                                        {{ i }} dB quieter
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>                                           
                </div>

                <div class="row">
                    <div class = "col-5"><span>
                        <label class = "TopForm">Filter</label>
                        <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title=Filter" data-bs-content="Enter keyword to filter elements during an element search.">?</a>
                    </span></div> 
                    <div class = "col-7">
                        <input type="text"  name="FilterField"
                               id="FilterField" value='{{ session["gstrFilterField"] }}'
                               class = "TopForm"
                               placeholder="Enter keyword"/>
                    </div>                                           
                </div>
                <div class="row">                
                    <div class = "col-7"  >
                        <!-- Toggle Display elements and searchj results --> 
                        {% if session["selectedelements"]|length > 0 %}
                            <button class="submit_button submit_button_active c-black "><a href="/showresults">Show Selected</a></button>
                        {% endif %}
                    </div> 
                    <div class = "col-5"  >
                        <button type="submit" value="Submit" class="submit_button submit_button_active c-black "> Search </button>
                    </div>
                </div>
            </div>
        </div>
     </div>
</div>
</form>

<!-- {% if session["status"] == "SearchDisplay" and querySearch is not defined %}
    <div class="container">
        <div class="measurement_result_block">
            <div class="measure_noise_block_inner">
                <div class="d-flex justify-content-space-between align-items-center clear_block">
                    <span class="fs-24">Results</span>
                </div>
                <div class="result_block d-flex align-items-center justify-content-center fs_20">
                    <div class="d-flex align-items-center justify-content-center">
                        You have no results yet
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %} -->

{% if BadEntry is defined %}
    <br>
    <h2 style = " padding-top: 18px; text-align:center;">


        {{ BadEntry }}

    </h3>

{% elif session["status"] == "ShareDisplay" and shareString is defined %}
<div class="container">
     <div class="TopFormCentre"> 
       <!-- <div class="row" >
            <div class = "col-12" style = "border:5px solid red; "> -->
                <div >
                    <br>
                    <p > Copy the link below to clipboard. You can paste the results into an email which can be sent to other users. </p>
                    <br>
                    <button id="shareCopy"  onclick = "Copy_Text()" > Copy text to clipboard  </button>
                    <br>
                    <br>
                    <textarea rows="5" cols="150" id="ShareString"> {{ shareString }} </textarea>
   
                </div>
               
        <!--    </div>
        </div> -->
    </div>
</div>

{% elif session["status"] == "SearchDisplay" and querySearch is defined %}

    <div class="container">
        <div class="row">
        <div class="measurement_result_block">
            <div class="measure_noise_block_inner">
                <!-- <div class="d-flex justify-content-space-between align-items-center clear_block"> -->
                <!-- <div class="d-flex justify-content-space-between align-items-center">
                    <span class="TopFormBold">Matching elements - click add to include</span>
                    <!-- <span class="fs-24">Matching elements - click add to include</span> 
                </div> --> 

                <!-- <div class="pagination fs-14 f-500"> -->
                <!--<div class = "container"> -->
                    <div class = "row">
                        <div class = "col-8" >
                            <nav aria-label="Page navigation example">
                                <ul class="pagination">
                                    {% if querySearch.has_prev %}
                                    <li class="page-item"><a class="page-link"
                                                            href="{{ url_for('paginate', page=querySearch.prev_num) }}">Previous</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item"><a class="page-link btn disabled" href="#">Previous</a></li>
                                    {% endif %}

                                    {% for page in querySearch.iter_pages(left_edge=3, right_edge=3) %}
                                    {% if page %}
                                    {% if page==querySearch.page %}
                                    <li class="page-item active"><a class="page-link" href="{{ url_for('paginate', page=page) }}">{{
                                        page }}</a></li>
                                    {% else %}
                                    <li class="page-item"><a class="page-link" href="{{ url_for('paginate', page=page) }}">{{ page
                                        }}</a></li>
                                    {% endif %}
                                    {% else %}
                                    <li class="page-item disabled" id="example_ellipsis"><a href="#" class="page-link">…</a></li>
                                    {% endif %}
                                    {% endfor %}

                                    {% if querySearch.has_next %}
                                    <li class="page-item"><a class="page-link"
                                                            href="{{ url_for('paginate', page=querySearch.next_num) }}">Next</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item"><a class="page-link btn disabled" href="#">Next</a></li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                        <div class = "col-4" >
                            <span class="pagination">Matching  elements-click add to include</span>
                        </div>                        
                    </div>                    
                <!-- </div> -->
                <!-- <div class="result_block d-flex align-items-center justify-content-center fs_20"> -->
                <div class="result_block d-flex align-items-center justify-content-center TopForm">
                    <!-- <div style="overflow: auto; height: 380px; width: 100%"> -->
                    <div style="overflow: auto; width: 100%">
                        <table id="customers">
                            <!--<tr class="fs-18 f-500"> -->
                            <tr class="TopForm"> 
                                <th>Spectra</th>
                                <th>Description</th>
                                {% for facade in facadedetails %}
                                    {% if facade.FacadeSpectra != "" %}                                
                                        <th><span>
                                        {{ facade.Label | safe }}
                                            <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Calculated Total " data-bs-content="This column shows what the overall internal level wll be if this element is added.">?</a>
                                          </span>
                                        </th>
                                    {% endif %}
                                {% endfor %}row
                                {% if session["selectedelements"]|length < 8 %}
                                <th><span>Select
                                    <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Select" data-bs-content="Click add to include this element.">?</a>
                                    </span>   
                                </th>
                                {% endif %}
                                <!-- <th>Actions</th> -->
                            </tr>
                            {% for row in querySearch.items %}
                            <tr>
                                <td>{{ row.Hz125|string + "/" + row.Hz250|string + "/" + row.Hz500|string + "/" +
                                   row.Hz1000|string + "/" + row.Hz2000|string }}
                                {% if row.URL %}
                                <td><a class = "c-blue" href = "{{ row.URL }}" target = "_blank">{{ row.Description }}</a></td>
                                {% else %}
                                <td>{{ row.Description }}</td>
                                {% endif %}                              
                                {% if df is defined %}
                                    {% for key, dfrow in df.iterrows() %}
                                        {% if row.UniqueID == dfrow.UniqueID %}
                                            {% for facade in facadedetails %}
                                                {% if facade.FacadeSpectra != "" %}
                                                    <td class="f-500">{{'%0.1f' % dfrow[facade.Metric] }}</td>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                {% if session["selectedelements"]|length < 8 %}
                                <td class="bluelink"><a  href="/add/{{row.UniqueID}}" method="POST">Add</a>
                                </td>
                                {% endif %}                              
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

{% elif session["status"] == "ElementDisplay" and selected is defined %}
    <div class="container">

        <div class="row">
        <div class="measurement_result_block" >
            <div class="measure_noise_block_inner">
                <div class="row">
                    <div class = "col-3"  >
                        <a class="about"  href="/share">Share</a>
                        <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Share" class="about" data-bs-content="Click to display the results in a format which can be shared electonically.">?</a>
                    </div> 
                    <div class = "col-3"  >
                        <a class="about" href="/download">Download</a>
                        <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Download" class="about" data-bs-content="Click  to download this selection as a spreadsheet">?</a>
                    </div> 
                </div>                
                <div>
                    <table id="example" class="table table-striped table-bordered" style="width:100%">
                        <tr>
                            <th>Area/Quantity</th>
                            <th>Type</th>
                            <th>Description</th>
                    {% for facade in facadedetails %}
                        {% if facade.FacadeSpectra != "" %}
                            <th>{{ facade.Label | safe }}</th>
                        {% endif %}   
                    {% endfor %}
                        {% if session["FacadeColumn"] == True %}
                            <th>Facade</th>
                        {% endif %}
                            <th>Selected<span>   
                                <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Selected" data-bs-content="Click on/off to include or exclude this element.">?</a>
                                </span>
                            </th>
                            <th>Remove<span>   
                                <a tabindex="0" href="#" data-bs-toggle="popover"  data-bs-trigger="focus"  title="Remove" data-bs-content="Click to remove element from calculation">?</a>
                            </span>
                            </th>
                        </tr>
                        {% for item in session["selectedelements"] %}
                        <tr>
                            {% if item['ElementType'] == "Vent" %}
                                <td>{{ item['Quantity'] }}No</td>
                            {% else %}
                                <td>{{ item['Quantity']|round(2) }} m<sup>2</sup></td>
                            {% endif %}

                            <td>{{ item['ElementType'] }}</td>
                            {% if item['URL']%}
                            <td><a class = "c-blue" href = "{{ item['URL']}}"  target = "_blank">{{ item['ElementDescription'] }}</a></td>
                            {% else %}
                            <td>{{ item['ElementDescription'] }}</td>
                            {% endif %}                              
            {% for facade in facadedetails %}
                {% if facade.FacadeSpectra != "" %}               
                    {% for elDetail in item['elementLevels'] %}
                        {% if elDetail.Metric == facade.Metric %}
                            <td> {{'%0.1f' % elDetail.Level|float}} ({{ elDetail.Percent }}%)</td>
                        {% endif %}
                    {% endfor %}
                {% endif %}                        
            {% endfor %}
                            {% if session["FacadeColumn"] == True %}
                            {% if item["FacadeDifference"] == 0 %}
                            <td> Main</td>
                            {% else %}
                            <td> {{ item["FacadeDifference"] }} dB quieter</td>
                            {% endif %}
                            {% endif %}
                            <td><a href="/change/{{item.ElementID}}" method="POST" class = "bluelink">{{ "On" if item["State"] == "Active" else "Off"
                                }}</a></td>
                            <td><a href="/remove/{{item.ElementID}}" method="POST" class = "bluelink">Remove</a></td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>                
        </div>
        </div>
    </div>

{% endif %}

{% endblock %}